# Product Digest

Medium-style product wiki for daily PM writing, built with Next.js + MDX.

## Programming languages used

- TypeScript (`.ts`, `.tsx`) for the Next.js app and most scripts.
- JavaScript (ESM, `.mjs`) for automation/ops scripts and backend server runtime.
- SQL (PostgreSQL) for persistence (subscribers, likes, product leaders).
- CSS for styling and design system tokens.
- MDX/Markdown for daily editorial content in `content/posts`.

## Quick start

```bash
nvm use 22 # if you use nvm
npm install
npm run dev
```

Open [http://localhost:3000](http://localhost:3000).

## Daily publishing workflow

Create a new post scaffold:

```bash
npm run new:post -- "Your post title"
```

Posts are stored in `content/posts` as `YYYY-MM-DD-slug.mdx`.

### Auto publish + push (cron)

To publish one draft per run and push to Git automatically:

```bash
npm run publish:next-draft:push
```

Example cron (daily at 07:00 CET):

```bash
0 7 * * * cd /Users/axi/Documents/product-digest && PUBLISH_GIT_SSH_KEY=/Users/axi/.ssh/id_ed25519_assarasua_user /opt/homebrew/bin/node scripts/publish-next-draft-push.mjs >> /Users/axi/Documents/product-digest/logs/publish-cron.log 2>&1
```

## Scheduled publishing with database (recommended cloud flow)

The project supports scheduled publication from PostgreSQL using a `scheduled_posts`
table. Each row points to an MDX file (`markdown_path`) and a `scheduled_at` timestamp.
When due, publication updates the article frontmatter to:
- `draft: false`
- `date` (from scheduled date)
- `publishAt` (ISO date-time)
- `updatedAt`

### Commands

```bash
DATABASE_URL="postgresql://..." npm run schedule:sync
DATABASE_URL="postgresql://..." npm run publish:scheduled
```

- `schedule:sync`: upserts draft MDX posts into `scheduled_posts`.
- `publish:scheduled`: publishes rows where `scheduled_at <= NOW()`.

### Cloud scheduler

GitHub Actions workflow:

- File: `.github/workflows/publish-scheduled.yml`
- Frequency: every 5 minutes
- Required secret: `DATABASE_URL`
- Behavior: publish due posts, regenerate search index, commit and push to `main` when there are changes.

### Git SSH (recommended)

Use a GitHub **Authentication key** (user key), not a repository deploy key:

```bash
git config core.sshCommand "ssh -i /Users/axi/.ssh/id_ed25519_assarasua_user -o IdentitiesOnly=yes"
```

## Build outputs

- Search index: `public/search-index.json` (generated in `prebuild`)
- RSS feed: `/rss.xml`
- Sitemap: `/sitemap.xml`

## Build and validation commands

- `npm run build:local`: fast local build (lint disabled)
- `npm run build:ci`: strict release/CI build path
- `npm run build:debug`: verbose build diagnostics
- `npm run check:runtime`: fails fast if Node is not 22.x
- `npm run check:types`: TypeScript validation
- `npm run check:types:debug`: TypeScript check with runtime timing output
- `npm run check:content`: frontmatter/content validation
- `npm run check:lint`: lint checks (currently intended as non-blocking in CI)
- `npm run doctor`: environment + content guardrail checks
- `npm run kill:next`: terminate stale Next/npm processes
- `npm run clean:next`: remove `.next` build/cache directory

## Quick Recovery (build hangs)

When build/check commands freeze, run these steps in order:

```bash
npm run kill:next
npm run clean:next
npm run doctor
```

Then retry:

```bash
npm run build:local
```

## Environment variables

- `NEXT_PUBLIC_SITE_URL` for canonical URLs and feed/sitemap links.
- `NEXT_PUBLIC_PLAUSIBLE_DOMAIN` to enable Plausible outbound-links analytics.
- `PUBLISH_GIT_REMOTE` optional (default `origin`) for cron publish script.
- `PUBLISH_GIT_BRANCH` optional (default `main`) for cron publish script.
- `PUBLISH_GIT_SSH_KEY` optional SSH private key path for cron non-interactive push.
- `PUBLISH_GIT_USER_NAME` optional fallback git user name for cron commit.
- `PUBLISH_GIT_USER_EMAIL` optional fallback git user email for cron commit.

## Cloudflare Deploy (Wrangler)

This project is configured for a `wrangler deploy` flow using static assets
generated by `@cloudflare/next-on-pages`.

### Build

```bash
npm run cf:build
```

### Deploy

```bash
npm run cf:deploy
```

`cf:deploy` runs:

```bash
npx wrangler deploy
```

Wrangler reads the asset directory from `wrangler.toml`:

```toml
[assets]
directory = ".vercel/output/static"
```

To prevent Wrangler from uploading private Pages worker internals, the build
creates `.vercel/output/static/.assetsignore` with:

```txt
_worker.js
```

## Railway Subscribe API (PostgreSQL)

Use this backend to store newsletter emails in Railway Postgres and connect it
to the Edge route used by the site.

### Start backend locally

```bash
npm install pg @types/pg
DATABASE_URL="postgresql://..." npm run backend:start
```

Server endpoints:
- `POST /api/subscribe`
- `POST /api/subscribers`
- `GET /api/likes?slug=<post-slug>`
- `POST /api/likes` with body `{ "slug": "<post-slug>" }`
- `GET /api/product-leaders`
- `GET /api/scheduled-posts`
- `POST /api/scheduled-posts` with body:
  - `slug`
  - `markdownPath`
  - `scheduledAt` (ISO)
  - `timezone` (optional, default `Europe/Madrid`)
  - `status` (`draft|scheduled|published`, optional)
- `GET /healthz`

### Connect frontend (Cloudflare)

The frontend currently posts directly to:

```bash
https://api.productdigest.es/api/subscribers
```

For Product Leaders wiki data:

```bash
NEXT_PUBLIC_PRODUCT_LEADERS_API_BASE_URL=https://api.productdigest.es
```
