# Product Digest

Medium-style product wiki for daily PM writing, built with Next.js + MDX.

## Programming languages used

- TypeScript (`.ts`, `.tsx`) for the Next.js app and most scripts.
- JavaScript (ESM, `.mjs`) for automation/ops scripts and backend server runtime.
- SQL (PostgreSQL) for persistence (subscribers, likes, product leaders).
- CSS for styling and design system tokens.
- MDX/Markdown for daily editorial content in `content/posts`.

## Quick start

```bash
nvm use 22 # if you use nvm
npm install
npm run dev
```

Open [http://localhost:3000](http://localhost:3000).

## Daily publishing workflow

Create a new post scaffold:

```bash
npm run new:post -- "Your post title"
```

Posts are stored in `content/posts` as `YYYY-MM-DD-slug.mdx`.

### Auto publish + push (cron)

To publish one draft per run and push to Git automatically:

```bash
npm run publish:next-draft:push
```

Example cron (daily at 07:00 CET):

```bash
0 7 * * * cd /Users/axi/Documents/product-digest && PUBLISH_GIT_SSH_KEY=/Users/axi/.ssh/id_ed25519_assarasua_user /opt/homebrew/bin/node scripts/publish-next-draft-push.mjs >> /Users/axi/Documents/product-digest/logs/publish-cron.log 2>&1
```

## Scheduled publishing with database (recommended cloud flow)

The project uses a two-table production flow:

- `scheduled_posts`: queue of drafts planned for publication.
- `posts`: published content consumed by the site/API.

When a row in `scheduled_posts` becomes due (`scheduled_at <= NOW()`), the
publisher upserts it into `posts` as `published` and marks the scheduled row as
`published`. MDX updates are optional (`PUBLISH_UPDATE_MDX=1`).

### Commands

```bash
DATABASE_URL="postgresql://..." npm run schedule:sync
DATABASE_URL="postgresql://..." npm run publish:scheduled
```

- `schedule:sync`: backfills draft MDX posts into `scheduled_posts`.
- `publish:scheduled`: moves due rows from `scheduled_posts` to `posts`.

### Cloud scheduler

GitHub Actions workflow:

- File: `.github/workflows/publish-scheduled.yml`
- Frequency: daily (plus manual `workflow_dispatch`)
- Required secret: `DATABASE_URL`
- Behavior: publish due posts, regenerate search index, commit and push to `main` when there are changes.

### Git SSH (recommended)

Use a GitHub **Authentication key** (user key), not a repository deploy key:

```bash
git config core.sshCommand "ssh -i /Users/axi/.ssh/id_ed25519_assarasua_user -o IdentitiesOnly=yes"
```

## Build outputs

- Search index: `public/search-index.json` (generated in `prebuild`)
- RSS feed: `/rss.xml`
- Sitemap: `/sitemap.xml`

## Build and validation commands

- `npm run build:local`: fast local build (lint disabled)
- `npm run build:ci`: strict release/CI build path
- `npm run build:debug`: verbose build diagnostics
- `npm run check:runtime`: fails fast if Node is not 22.x
- `npm run check:types`: TypeScript validation
- `npm run check:types:debug`: TypeScript check with runtime timing output
- `npm run check:content`: frontmatter/content validation
- `npm run check:lint`: lint checks (currently intended as non-blocking in CI)
- `npm run doctor`: environment + content guardrail checks
- `npm run kill:next`: terminate stale Next/npm processes
- `npm run clean:next`: remove `.next` build/cache directory

## Quick Recovery (build hangs)

When build/check commands freeze, run these steps in order:

```bash
npm run kill:next
npm run clean:next
npm run doctor
```

Then retry:

```bash
npm run build:local
```

## Environment variables

- `NEXT_PUBLIC_SITE_URL` for canonical URLs and feed/sitemap links.
- `NEXT_PUBLIC_PLAUSIBLE_DOMAIN` to enable Plausible outbound-links analytics.
- `PUBLISH_GIT_REMOTE` optional (default `origin`) for cron publish script.
- `PUBLISH_GIT_BRANCH` optional (default `main`) for cron publish script.
- `PUBLISH_GIT_SSH_KEY` optional SSH private key path for cron non-interactive push.
- `PUBLISH_GIT_USER_NAME` optional fallback git user name for cron commit.
- `PUBLISH_GIT_USER_EMAIL` optional fallback git user email for cron commit.

## Cloudflare Deploy (Wrangler)

This project is configured for a `wrangler deploy` flow using static assets
generated by `@cloudflare/next-on-pages`.

### Build

```bash
npm run cf:build
```

### Deploy

```bash
npm run cf:deploy
```

`cf:deploy` runs:

```bash
npx wrangler deploy
```

Wrangler reads the asset directory from `wrangler.toml`:

```toml
[assets]
directory = ".vercel/output/static"
```

To prevent Wrangler from uploading private Pages worker internals, the build
creates `.vercel/output/static/.assetsignore` with:

```txt
_worker.js
```

## Railway Subscribe API (PostgreSQL)

Use this backend to store newsletter emails in Railway Postgres and connect it
to the Edge route used by the site.

### Start backend locally

```bash
npm install pg @types/pg
DATABASE_URL="postgresql://..." npm run backend:start
```

Server endpoints:
- `GET /api/posts?status=published|scheduled|draft|all&tag=<tag>&q=<query>&limit=20&offset=0`
- `GET /api/posts/:slug`
- `POST /api/posts` with body:
  - `slug`
  - `title`
  - `summary`
  - `contentMd`
  - `tags` (`string[]`)
  - `status` (`draft|scheduled|published`)
  - `scheduledAt` (optional ISO)
- `PATCH /api/posts/:slug/schedule` with body `{ "scheduledAt": "<ISO>" }`
- `POST /api/posts/:slug/publish`
- `POST /api/subscribe`
- `POST /api/subscribers`
- `GET /api/likes?slug=<post-slug>`
- `POST /api/likes` with body `{ "slug": "<post-slug>" }`
- `GET /api/product-leaders`
- `GET /api/scheduled-posts`
- `POST /api/scheduled-posts` with body:
  - `slug`
  - `markdownPath` (optional, defaults to `db://<slug>`)
  - `title` (optional if MDX path is provided)
  - `summary` (optional if MDX path is provided)
  - `contentMd` (optional if MDX path is provided)
  - `tags` (`string[]`, optional)
  - `scheduledAt` (ISO)
  - `timezone` (optional, default `Europe/Madrid`)
  - `status` (`draft|scheduled|published`, optional)
- `GET /healthz`

### DB-first publishing flow (production)

Use PostgreSQL as source of truth:

1. Create/update a post directly in DB:

```bash
DATABASE_URL="postgresql://..." npm run new:post:db -- \
  --slug "mi-post" \
  --title "Mi post" \
  --summary "Resumen breve" \
  --scheduledAt "2026-02-21T08:00:00+01:00" \
  --tags "producto,ai" \
  --content "Contenido en markdown"
```

2. Auto-publish due posts (cron/CI):

```bash
DATABASE_URL="postgresql://..." npm run publish:scheduled
```

`publish:scheduled` publishes from `scheduled_posts` into `posts` in PostgreSQL
when `scheduled_at <= NOW()`. Set `PUBLISH_UPDATE_MDX=1` only if you also want
to keep legacy MDX files synchronized.

### Connect frontend (Cloudflare)

The frontend currently posts directly to:

```bash
https://api.productdigest.es/api/subscribers
```

For Product Leaders wiki data:

```bash
NEXT_PUBLIC_PRODUCT_LEADERS_API_BASE_URL=https://api.productdigest.es
```
